{% extends 'pwa/base.html' %}
{% load i18n %}

{% block extra_head %}
<script src="https://unpkg.com/@zxing/library@latest/umd/index.min.js"></script>
{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <div class="bg-white overflow-hidden shadow rounded-lg">
        <div class="px-4 py-5 sm:p-6">
            <h1 class="text-2xl font-bold text-gray-900 mb-6">
                {% trans "Scan QR Code" %}
            </h1>
            
            <!-- Camera View -->
            <div class="mb-6">
                <div class="relative bg-black rounded-lg overflow-hidden" style="height: 400px;">
                    <video id="video" class="w-full h-full object-cover" autoplay muted playsinline></video>
                    <div id="loading" class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-50 text-white">
                        <div class="text-center">
                            <div class="animate-spin rounded-full h-32 w-32 border-b-2 border-white mb-4"></div>
                            <p>{% trans "Initializing camera..." %}</p>
                        </div>
                    </div>
                    <div id="no-camera" class="absolute inset-0 flex items-center justify-center bg-gray-800 text-white hidden">
                        <div class="text-center">
                            <svg class="h-16 w-16 mx-auto mb-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                            </svg>
                            <p class="text-lg font-medium">{% trans "Camera access required" %}</p>
                            <p class="text-sm text-gray-400 mt-2">
                                {% trans "Please allow camera access to scan QR codes" %}
                            </p>
                            <button id="retry-camera" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                                {% trans "Retry" %}
                            </button>
                        </div>
                    </div>
                    
                    <!-- Scan overlay -->
                    <div id="scan-overlay" class="absolute inset-0 hidden">
                        <div class="absolute inset-0 bg-black bg-opacity-50"></div>
                        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2">
                            <div class="w-64 h-64 border-4 border-white border-opacity-50 rounded-lg relative">
                                <div class="absolute top-0 left-0 w-8 h-8 border-t-4 border-l-4 border-blue-400"></div>
                                <div class="absolute top-0 right-0 w-8 h-8 border-t-4 border-r-4 border-blue-400"></div>
                                <div class="absolute bottom-0 left-0 w-8 h-8 border-b-4 border-l-4 border-blue-400"></div>
                                <div class="absolute bottom-0 right-0 w-8 h-8 border-b-4 border-r-4 border-blue-400"></div>
                                <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-full h-1 bg-red-500 opacity-75 animate-pulse"></div>
                            </div>
                        </div>
                        <div class="absolute bottom-4 left-1/2 transform -translate-x-1/2 text-white text-center">
                            <p class="text-lg font-medium">{% trans "Point camera at QR code" %}</p>
                            <p class="text-sm text-gray-300">{% trans "QR code will be scanned automatically" %}</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Controls -->
            <div class="flex flex-wrap gap-4 mb-6">
                <button id="start-scan" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 disabled:bg-gray-400">
                    {% trans "Start Scanning" %}
                </button>
                <button id="stop-scan" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 disabled:bg-gray-400" disabled>
                    {% trans "Stop Scanning" %}
                </button>
                <button id="switch-camera" class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700 disabled:bg-gray-400" disabled>
                    {% trans "Switch Camera" %}
                </button>
                <button id="toggle-flash" class="px-4 py-2 bg-yellow-600 text-white rounded hover:bg-yellow-700 disabled:bg-gray-400" disabled>
                    {% trans "Toggle Flash" %}
                </button>
            </div>
            
            <!-- Scan Result -->
            <div id="scan-result" class="hidden">
                <div class="bg-green-50 border border-green-200 rounded-lg p-6">
                    <h3 class="text-lg font-medium text-green-900 mb-4">
                        {% trans "QR Code Detected" %}
                    </h3>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            {% trans "Scanned Content" %}:
                        </label>
                        <div id="scan-content" class="bg-white border border-gray-300 rounded px-3 py-2 text-sm font-mono"></div>
                    </div>
                    <div class="flex flex-wrap gap-3">
                        <button id="open-article" class="hidden px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                            {% trans "View Article" %}
                        </button>
                        <button id="quick-add" class="hidden px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
                            {% trans "Quick Add to Cart" %}
                        </button>
                        <button id="quick-use" class="hidden px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700">
                            {% trans "Quick Declare Usage" %}
                        </button>
                        <button id="scan-again" class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700">
                            {% trans "Scan Again" %}
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Manual Entry -->
            <div class="mt-8 border-t border-gray-200 pt-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">
                    {% trans "Manual Entry" %}
                </h3>
                <p class="text-sm text-gray-600 mb-4">
                    {% trans "Can't scan? Enter the article reference manually:" %}
                </p>
                <div class="flex gap-3">
                    <input 
                        type="text" 
                        id="manual-reference" 
                        placeholder="{% trans 'Article Reference' %}"
                        class="flex-1 border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    >
                    <button id="manual-submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                        {% trans "Look Up" %}
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Action Modals -->
<div id="quick-add-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <h3 class="text-lg font-medium text-gray-900 mb-4">{% trans "Quick Add to Cart" %}</h3>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">{% trans "Quantity" %}:</label>
                <input type="number" id="add-quantity" min="0.01" step="0.01" value="1" class="w-full border border-gray-300 rounded px-3 py-2">
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">{% trans "Notes" %} ({% trans "optional" %}):</label>
                <textarea id="add-notes" rows="2" class="w-full border border-gray-300 rounded px-3 py-2"></textarea>
            </div>
            <div class="flex gap-3">
                <button id="confirm-add" class="flex-1 px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
                    {% trans "Add to Cart" %}
                </button>
                <button id="cancel-add" class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400">
                    {% trans "Cancel" %}
                </button>
            </div>
        </div>
    </div>
</div>

<div id="quick-use-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <h3 class="text-lg font-medium text-gray-900 mb-4">{% trans "Quick Declare Usage" %}</h3>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">{% trans "Quantity Used" %}:</label>
                <input type="number" id="use-quantity" min="0.01" step="0.01" value="1" class="w-full border border-gray-300 rounded px-3 py-2">
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">{% trans "Location/Usage" %}:</label>
                <input type="text" id="use-location" placeholder="{% trans 'Where was this used?' %}" class="w-full border border-gray-300 rounded px-3 py-2">
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">{% trans "Notes" %} ({% trans "optional" %}):</label>
                <textarea id="use-notes" rows="2" class="w-full border border-gray-300 rounded px-3 py-2"></textarea>
            </div>
            <div class="flex gap-3">
                <button id="confirm-use" class="flex-1 px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700">
                    {% trans "Declare Usage" %}
                </button>
                <button id="cancel-use" class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400">
                    {% trans "Cancel" %}
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="/static/js/qr-scanner.js"></script>
{% endblock %}
